{"name": "Ecshop-LOGIN-002 使用错误用户名登录提示报错信息", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望包含: '用户名或密码错误' 同义: ['用户名或密码错误', '账号或密码错误', '帐号或密码错误', '用户名或密码错误', '用户名错误', '密码错误', '账号错误', '帐号错误'] 实际候选命中: ''", "trace": "case = {'expected': {'message_contains': '用户名或密码错误', 'ok': False, 'selector': \"xpath=//div[contains(@class,'boxCenterList')]/...N-002', 'input': {'password': 'ecshop', 'remember': False, 'username': 'ecshop1'}, 'marks': ['smoke', 'negative'], ...}\ndriver = <selenium.webdriver.chrome.webdriver.WebDriver (session=\"bd8dd408e6ca6b2a1c8c0c5a86c7e22e\")>, base_url = 'http://localhost'\nconfig = {'base_url': 'http://localhost', 'password': 'ecshop', 'username': 'ecshop'}\n\n    @allure.feature(\"Account\")\n    @allure.story(\"Login\")\n    @pytest.mark.parametrize(\"case\", _load_cases(DATA_DIR / \"login.yaml\"))\n    def test_login(case, driver, base_url, config):\n        \"\"\"\n        冒烟 + 回归：登录正/反向用例\n        使用 fixtures:\n          - driver: selenium webdriver\n          - base_url: 从 environment.yaml 读取\n          - config: 默认账号配置\n        \"\"\"\n        allure.dynamic.title(f'{case[\"id\"]} {case[\"title\"]}')\n    \n        page = LoginPage(driver, base_url).open()\n    \n        # 仅当键不存在时才回退到 config；若键存在（哪怕是空字符串）就使用用例中的值\n        username = case[\"input\"][\"username\"] if \"username\" in case[\"input\"] else config.get(\"username\")\n        password = case[\"input\"][\"password\"] if \"password\" in case[\"input\"] else config.get(\"password\")\n        remember = case[\"input\"].get(\"remember\", case[\"input\"].get(\"remember_me\", False))\n    \n        with allure.step(\"填写并提交登录\"):\n            page.login(username=username, password=password, remember=remember)\n    \n        with allure.step(\"断言登录结果\"):\n            if case[\"expected\"].get(\"ok\"):\n                landing = case[\"expected\"].get(\"landing\")\n                try:\n                    if landing:\n                        page.assert_login_success(landing)\n                    else:\n                        page.assert_login_success()\n                except TypeError:\n                    page.assert_login_success()\n            else:\n                expected_msg = case[\"expected\"].get(\"message_contains\", \"\")\n                selector = case[\"expected\"].get(\"selector\")\n                timeout = case[\"expected\"].get(\"wait\", 3)\n    \n                # 先尝试 JS alert，再回退页面元素\n                alert_handled = False\n                try:\n                    page.assert_alert_contains(expected_msg, timeout=timeout)\n                    alert_handled = True\n                except Exception:\n                    pass\n    \n                if not alert_handled:\n>                   page.assert_error_contains(expected_msg, selector=selector, timeout=timeout)\n\ntestcases\\account\\test_login_smoke.py:378: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nself = <pageobjects.account.LoginPage.LoginPage object at 0x03E1EA20>, expected_substring = '用户名或密码错误'\nselector = \"xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]\", timeout = 5, allow_synonyms = True\n\n    @allure.step(\"断言错误提示包含期望文案（增强版）\")\n    def assert_error_contains(\n        self,\n        expected_substring: str,\n        selector: Optional[str] = None,\n        timeout: int = 5,\n        allow_synonyms: bool = True\n    ):\n        \"\"\"\n        增强：\n          1. 若提供 selector，则等待文本出现（text_to_be_present_in_element）\n          2. 若未匹配到，收集候选错误元素文本（ERROR_ZONES + 可能的容器）\n          3. 在 page_source 中做全文近似搜索\n          4. 支持同义或变体文案（账号/用户名, 或/和, 用户名或密码错误 -> 密码错误 / 用户名错误 等）\n          5. Allure 附件：候选文本列表、最终命中、page-source、截图\n        \"\"\"\n        expected_substring = (expected_substring or \"\").strip()\n        found_text = \"\"\n        hit_variant = \"\"\n    \n        synonyms: List[str] = []\n        if allow_synonyms and expected_substring:\n            # 针对常见登录失败提示的中文变体\n            if expected_substring in (\"用户名或密码错误\", \"账号或密码错误\", \"帐号或密码错误\"):\n                synonyms = [\n                    expected_substring,\n                    \"账号或密码错误\",\n                    \"帐号或密码错误\",\n                    \"用户名或密码错误\",\n                    \"用户名错误\",\n                    \"密码错误\",\n                    \"账号错误\",\n                    \"帐号错误\",\n                ]\n    \n        # 1. 使用 selector 定位\n        if selector:\n            try:\n                loc = self._parse_selector(selector)\n                if expected_substring:\n                    try:\n                        WebDriverWait(self.driver, timeout).until(\n                            EC.text_to_be_present_in_element(loc, expected_substring)\n                        )\n                    except Exception:\n                        # 如果严格文本等待失败，仍尝试拿元素\n                        pass\n                el = self._wait_present(loc, timeout=timeout)\n                found_text = el.text.strip()\n            except Exception:\n                pass  # 进入后续兜底\n    \n        # 2. 如果 selector 没拿到，使用错误区域列表\n        candidate_texts: List[str] = []\n        if not found_text:\n            for zone in self.ERROR_ZONES:\n                try:\n                    elements = self.driver.find_elements(*zone)\n                    for e in elements:\n                        txt = (e.text or \"\").strip()\n                        if txt:\n                            candidate_texts.append(txt)\n                except Exception:\n                    continue\n    \n        # 额外扩大搜索范围（登录表单附近 p / div / font）\n        try:\n            extra_candidates = self.driver.find_elements(\n                By.XPATH,\n                \"//div[contains(@class,'boxCenterList')]//*[self::p or self::div or self::span or self::font]\"\n            )\n            for e in extra_candidates:\n                txt = (e.text or \"\").strip()\n                if txt and txt not in candidate_texts:\n                    candidate_texts.append(txt)\n        except Exception:\n            pass\n    \n        # 如果还没有 found_text，选一个最可能的（长度包含“错”/“密”/“户”等关键字）\n        if not found_text and candidate_texts:\n            priority = sorted(\n                candidate_texts,\n                key=lambda t: (\n                    -int(any(k in t for k in [\"错\", \"密\", \"户\", \"账号\", \"密码\"])),\n                    -len(t)\n                )\n            )\n            found_text = priority[0]\n    \n        # 3. 变体/同义匹配\n        def matches(text: str) -> bool:\n            if not expected_substring and not synonyms:\n                return False\n            if expected_substring and expected_substring in text:\n                return True\n            for s in synonyms:\n                if s and s in text:\n                    return True\n            return False\n    \n        # 4. 如果当前 found_text 不包含期望/同义，尝试在所有候选中寻找\n        if not matches(found_text):\n            variant_hit = next((t for t in candidate_texts if matches(t)), \"\")\n            if variant_hit:\n                hit_variant = variant_hit\n                found_text = variant_hit\n    \n        # 5. 如果仍不匹配，尝试直接在 page_source 中找\n        if not matches(found_text):\n            page_src = self.driver.page_source or \"\"\n            if expected_substring and expected_substring in page_src:\n                found_text = expected_substring  # 直接承认从源码命中\n            else:\n                for s in synonyms:\n                    if s and s in page_src:\n                        found_text = s\n                        hit_variant = s\n                        break\n                if not matches(found_text):\n                    # 正则近似（围绕错误关键词）\n                    regex_patterns = [\n                        rf\"[^<>]{{0,60}}{re.escape(expected_substring)}[^<>]{{0,60}}\" if expected_substring else \"\",\n                        r\"(?:用户名|账号|帐号)[^<>]{0,20}(?:错误|不存在)\",\n                        r\"(?:密码)[^<>]{0,20}(?:错误|不正确)\",\n                    ]\n                    for rp in regex_patterns:\n                        if not rp:\n                            continue\n                        m = re.search(rp, page_src)\n                        if m:\n                            found_text = m.group(0).strip()\n                            break\n    \n        # 附件输出\n        self._attach_screenshot(\"login-error-screenshot\")\n        self._attach_source()\n        allure.attach(\n            \"\\n\".join(candidate_texts) or \"EMPTY\",\n            name=\"login-error-candidates\",\n            attachment_type=allure.attachment_type.TEXT\n        )\n        allure.attach(found_text or \"EMPTY\", name=\"login-error-final\", attachment_type=allure.attachment_type.TEXT)\n        if hit_variant:\n            allure.attach(hit_variant, name=\"login-error-variant-hit\", attachment_type=allure.attachment_type.TEXT)\n    \n        # 最终判定\n        if not matches(found_text):\n>           raise AssertionError(\n                f\"未匹配到错误提示。期望包含: '{expected_substring}' 同义: {synonyms or '无'} 实际候选命中: '{found_text}'\"\n            )\nE           AssertionError: 未匹配到错误提示。期望包含: '用户名或密码错误' 同义: ['用户名或密码错误', '账号或密码错误', '帐号或密码错误', '用户名或密码错误', '用户名错误', '密码错误', '账号错误', '帐号错误'] 实际候选命中: ''\n\npageobjects\\account\\LoginPage.py:1306: AssertionError"}, "description": "\n    冒烟 + 回归：登录正/反向用例\n    使用 fixtures:\n      - driver: selenium webdriver\n      - base_url: 从 environment.yaml 读取\n      - config: 默认账号配置\n    ", "steps": [{"name": "打开登录入口", "status": "passed", "start": 1762592923199, "stop": 1762593043612}, {"name": "填写并提交登录", "status": "passed", "steps": [{"name": "填写并提交登录表单", "status": "passed", "parameters": [{"name": "username", "value": "'ecshop1'"}, {"name": "password", "value": "'ecshop'"}, {"name": "remember", "value": "False"}], "start": 1762593043612, "stop": 1762593047966}], "start": 1762593043612, "stop": 1762593047966}, {"name": "断言登录结果", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望包含: '用户名或密码错误' 同义: ['用户名或密码错误', '账号或密码错误', '帐号或密码错误', '用户名或密码错误', '用户名错误', '密码错误', '账号错误', '帐号错误'] 实际候选命中: ''\n", "trace": "  File \"D:\\POM_WebUITest\\testcases\\account\\test_login_smoke.py\", line 378, in test_login\n    page.assert_error_contains(expected_msg, selector=selector, timeout=timeout)\n  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 1306, in assert_error_contains\n    raise AssertionError(\n"}, "steps": [{"name": "断言（若存在）JS Alert 错误提示", "status": "failed", "statusDetails": {"message": "AssertionError: 未检测到 alert\n", "trace": "  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 1322, in assert_alert_contains\n    raise AssertionError(\"未检测到 alert\")\n"}, "parameters": [{"name": "expected_substring", "value": "'用户名或密码错误'"}, {"name": "timeout", "value": "5"}], "start": 1762593047967, "stop": 1762593055174}, {"name": "断言错误提示包含期望文案（增强版）", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望包含: '用户名或密码错误' 同义: ['用户名或密码错误', '账号或密码错误', '帐号或密码错误', '用户名或密码错误', '用户名错误', '密码错误', '账号错误', '帐号错误'] 实际候选命中: ''\n", "trace": "  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 1306, in assert_error_contains\n    raise AssertionError(\n"}, "attachments": [{"name": "login-error-screenshot", "source": "0e520b44-1766-4b6d-8906-d32d565b6a92-attachment.png", "type": "image/png"}, {"name": "page-source", "source": "f87ea58f-bb60-4c33-b804-cb8ca317d632-attachment.txt", "type": "text/plain"}, {"name": "login-error-candidates", "source": "5aa646fe-3eda-4dc9-b4c4-8de13e98e744-attachment.txt", "type": "text/plain"}, {"name": "login-error-final", "source": "413834e6-e79d-4f1d-8b9b-25811a964302-attachment.txt", "type": "text/plain"}], "parameters": [{"name": "expected_substring", "value": "'用户名或密码错误'"}, {"name": "selector", "value": "'xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]'"}, {"name": "timeout", "value": "5"}, {"name": "allow_synonyms", "value": "True"}], "start": 1762593055177, "stop": 1762593085413}], "start": 1762593047966, "stop": 1762593085414}], "parameters": [{"name": "case", "value": "{'id': 'Ecshop-LOGIN-002', 'title': '使用错误用户名登录提示报错信息', 'input': {'username': 'ecshop1', 'password': 'ecshop', 'remember': False}, 'expected': {'ok': False, 'message_contains': '用户名或密码错误', 'selector': \"xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]\", 'wait': 5}, 'marks': ['smoke', 'negative']}"}], "start": 1762592923198, "stop": 1762593085415, "uuid": "ffa5ce6b-03a1-4861-9442-9cea50506333", "historyId": "76fdb11bcd0d27b000d35a95f41bbfe2", "testCaseId": "1c71e20e073fc747fdf03f814ed0bc40", "fullName": "testcases.account.test_login_smoke#test_login", "labels": [{"name": "story", "value": "Login"}, {"name": "feature", "value": "Account"}, {"name": "tag", "value": "smoke"}, {"name": "tag", "value": "negative"}, {"name": "parentSuite", "value": "testcases.account"}, {"name": "suite", "value": "test_login_smoke"}, {"name": "host", "value": "class016"}, {"name": "thread", "value": "2672-MainThread"}, {"name": "framework", "value": "pytest"}, {"name": "language", "value": "cpython3"}, {"name": "package", "value": "testcases.account.test_login_smoke"}]}