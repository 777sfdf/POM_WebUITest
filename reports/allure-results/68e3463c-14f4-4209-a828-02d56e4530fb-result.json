{"name": "Ecshop-LOGIN-002 使用错误用户名登录提示报错信息", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望: '用户名或密码错误' 实际: '密码'", "trace": "case = {'expected': {'message_contains': '用户名或密码错误', 'ok': False, 'selector': \"xpath=//div[contains(@class,'boxCenterList')]/...N-002', 'input': {'password': 'ecshop', 'remember': False, 'username': 'ecshop1'}, 'marks': ['smoke', 'negative'], ...}\ndriver = <selenium.webdriver.chrome.webdriver.WebDriver (session=\"02b0e98dd78987533813f55f1d643cc4\")>, base_url = 'http://localhost'\nconfig = {'base_url': 'http://localhost', 'password': 'ecshop', 'username': 'ecshop'}\n\n    @allure.feature(\"Account\")\n    @allure.story(\"Login\")\n    @pytest.mark.parametrize(\"case\", _load_cases(DATA_DIR / \"login.yaml\"))\n    def test_login(case, driver, base_url, config):\n        \"\"\"\n        冒烟 + 回归：登录正/反向用例\n        使用 fixtures:\n          - driver: selenium webdriver\n          - base_url: 从 environment.yaml 读取\n          - config: 默认账号配置\n        \"\"\"\n        allure.dynamic.title(f'{case[\"id\"]} {case[\"title\"]}')\n    \n        page = LoginPage(driver, base_url).open()\n    \n        # 仅当键不存在时才回退到 config；若键存在（哪怕是空字符串）就使用用例中的值\n        username = case[\"input\"][\"username\"] if \"username\" in case[\"input\"] else config.get(\"username\")\n        password = case[\"input\"][\"password\"] if \"password\" in case[\"input\"] else config.get(\"password\")\n        remember = case[\"input\"].get(\"remember\", case[\"input\"].get(\"remember_me\", False))\n    \n        with allure.step(\"填写并提交登录\"):\n            page.login(username=username, password=password, remember=remember)\n    \n        with allure.step(\"断言登录结果\"):\n            if case[\"expected\"].get(\"ok\"):\n                landing = case[\"expected\"].get(\"landing\")\n                try:\n                    if landing:\n                        page.assert_login_success(landing)\n                    else:\n                        page.assert_login_success()\n                except TypeError:\n                    page.assert_login_success()\n            else:\n                expected_msg = case[\"expected\"].get(\"message_contains\", \"\")\n                selector = case[\"expected\"].get(\"selector\")\n                timeout = case[\"expected\"].get(\"wait\", 3)\n    \n                # 先尝试 JS alert，再回退页面元素\n                alert_handled = False\n                try:\n                    page.assert_alert_contains(expected_msg, timeout=timeout)\n                    alert_handled = True\n                except Exception:\n                    pass\n    \n                if not alert_handled:\n>                   page.assert_error_contains(expected_msg, selector=selector, timeout=timeout)\n\ntestcases\\account\\test_login_smoke.py:378: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nself = <pageobjects.account.LoginPage.LoginPage object at 0x0445E1F8>, expected_substring = '用户名或密码错误'\nselector = \"xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]\", timeout = 15\n\n    @allure.step(\"断言错误提示包含期望文案（优先严格使用 selector）\")\n    def assert_error_contains(\n        self,\n        expected_substring: str,\n        selector: Optional[str] = None,\n        timeout: int = 5\n    ):\n        expected_substring = (expected_substring or \"\").strip()\n        found_text = \"\"\n        meta = []\n    \n        if selector:\n            # 与你手工脚本一致：等待最长 15 秒（或更长，如果传入更大）\n            effective_timeout = max(timeout, 15)\n            try:\n                loc = self._parse_selector(selector)\n                meta.append(f\"selector={selector}\")\n                # 先等节点出现\n                el = self._wait_present(loc, timeout=effective_timeout)\n                # 再等文本包含期望子串\n                if expected_substring:\n                    self._wait_text_in_element(loc, expected_substring, timeout=effective_timeout)\n                    # 重新获取文本\n                    el = self.driver.find_element(*loc)\n                found_text = (el.text or \"\").strip()\n                # 附上 outerHTML 帮助排查\n                try:\n                    outer = el.get_attribute(\"outerHTML\")\n                    allure.attach(outer or \"\", name=\"selector-outerHTML\", attachment_type=allure.attachment_type.TEXT)\n                except Exception:\n                    pass\n            except Exception as e:\n                # selector 路径无法定位时才回退 ERROR_ZONES\n                meta.append(f\"selector_failed={repr(e)}\")\n    \n        if not found_text:\n            try:\n                el = self._try_first_present(self.ERROR_ZONES, timeout=max(timeout, 5))\n                found_text = (el.text or \"\").strip()\n            except Exception:\n                found_text = self._find_error_text_from_source(expected_substring)\n    \n        # 附件与断言\n        self._attach_screenshot(\"login-error-screenshot\")\n        self._attach_source()\n        allure.attach(found_text or \"EMPTY\", name=\"login-error-text\", attachment_type=allure.attachment_type.TEXT)\n        if meta:\n            allure.attach(\" | \".join(meta), name=\"login-error-meta\", attachment_type=allure.attachment_type.TEXT)\n    \n        if expected_substring and expected_substring not in found_text:\n>           raise AssertionError(\n                f\"未匹配到错误提示。期望: '{expected_substring}' 实际: '{found_text}'\"\n            )\nE           AssertionError: 未匹配到错误提示。期望: '用户名或密码错误' 实际: '密码'\n\npageobjects\\account\\LoginPage.py:593: AssertionError"}, "description": "\n    冒烟 + 回归：登录正/反向用例\n    使用 fixtures:\n      - driver: selenium webdriver\n      - base_url: 从 environment.yaml 读取\n      - config: 默认账号配置\n    ", "steps": [{"name": "打开登录入口", "status": "passed", "start": 1762595292700, "stop": 1762595301062}, {"name": "填写并提交登录", "status": "passed", "steps": [{"name": "填写并提交登录表单", "status": "passed", "parameters": [{"name": "username", "value": "'ecshop1'"}, {"name": "password", "value": "'ecshop'"}, {"name": "remember", "value": "False"}], "start": 1762595301062, "stop": 1762595301202}], "start": 1762595301062, "stop": 1762595301202}, {"name": "断言登录结果", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望: '用户名或密码错误' 实际: '密码'\n", "trace": "  File \"D:\\POM_WebUITest\\testcases\\account\\test_login_smoke.py\", line 378, in test_login\n    page.assert_error_contains(expected_msg, selector=selector, timeout=timeout)\n  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 593, in assert_error_contains\n    raise AssertionError(\n"}, "steps": [{"name": "断言（若存在）JS Alert 错误提示", "status": "failed", "statusDetails": {"message": "AssertionError: 未检测到 alert\n", "trace": "  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 609, in assert_alert_contains\n    raise AssertionError(\"未检测到 alert\")\n"}, "parameters": [{"name": "expected_substring", "value": "'用户名或密码错误'"}, {"name": "timeout", "value": "15"}], "start": 1762595301202, "stop": 1762595316591}, {"name": "断言错误提示包含期望文案（优先严格使用 selector）", "status": "failed", "statusDetails": {"message": "AssertionError: 未匹配到错误提示。期望: '用户名或密码错误' 实际: '密码'\n", "trace": "  File \"C:\\Users\\admin\\AppData\\Local\\Programs\\Python\\Python312-32\\Lib\\site-packages\\allure_commons\\_allure.py\", line 192, in impl\n    return func(*a, **kw)\n           ^^^^^^^^^^^^^^\n  File \"D:\\POM_WebUITest\\pageobjects\\account\\LoginPage.py\", line 593, in assert_error_contains\n    raise AssertionError(\n"}, "attachments": [{"name": "login-error-screenshot", "source": "aabf4993-7483-4c6b-8cde-ff15d6ca7b9a-attachment.png", "type": "image/png"}, {"name": "page-source", "source": "4c0e05d6-6b76-4bbe-afb4-c652cf96558d-attachment.txt", "type": "text/plain"}, {"name": "login-error-text", "source": "5603e0ac-844a-4924-998e-801f515887d8-attachment.txt", "type": "text/plain"}, {"name": "login-error-meta", "source": "89d3cc79-6db5-4ac7-a2cd-243e807fcc94-attachment.txt", "type": "text/plain"}], "parameters": [{"name": "expected_substring", "value": "'用户名或密码错误'"}, {"name": "selector", "value": "'xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]'"}, {"name": "timeout", "value": "15"}], "start": 1762595316594, "stop": 1762595381051}], "start": 1762595301202, "stop": 1762595381052}], "parameters": [{"name": "case", "value": "{'id': 'Ecshop-LOGIN-002', 'title': '使用错误用户名登录提示报错信息', 'input': {'username': 'ecshop1', 'password': 'ecshop', 'remember': False}, 'expected': {'ok': False, 'message_contains': '用户名或密码错误', 'selector': \"xpath=//div[contains(@class,'boxCenterList')]//p[contains(normalize-space(.),'用户名或密码错误')]\", 'wait': 15}, 'marks': ['smoke', 'negative']}"}], "start": 1762595292700, "stop": 1762595381053, "uuid": "274a5e77-ba20-4014-b489-d265eb612da1", "historyId": "76fdb11bcd0d27b000d35a95f41bbfe2", "testCaseId": "1c71e20e073fc747fdf03f814ed0bc40", "fullName": "testcases.account.test_login_smoke#test_login", "labels": [{"name": "feature", "value": "Account"}, {"name": "story", "value": "Login"}, {"name": "tag", "value": "smoke"}, {"name": "tag", "value": "negative"}, {"name": "parentSuite", "value": "testcases.account"}, {"name": "suite", "value": "test_login_smoke"}, {"name": "host", "value": "class016"}, {"name": "thread", "value": "10068-MainThread"}, {"name": "framework", "value": "pytest"}, {"name": "language", "value": "cpython3"}, {"name": "package", "value": "testcases.account.test_login_smoke"}]}